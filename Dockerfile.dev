# Development Dockerfile with hot reloading support
FROM node:20-alpine

# Install system dependencies
RUN apk add --no-cache libc6-compat postgresql-client bash curl

WORKDIR /app

# Install pnpm
RUN npm install -g pnpm

# Copy package files
COPY package.json pnpm-lock.yaml ./

# Install all dependencies (including dev dependencies)
RUN pnpm install --frozen-lockfile

# Copy source code
COPY . .

# Create uploads and logs directories
RUN mkdir -p /app/uploads /app/logs

# Accept build arguments for user/group IDs from host
ARG USER_ID=1001
ARG GROUP_ID=1001
ARG USERNAME=appuser

# Create group and user with host OS IDs
RUN addgroup --system --gid ${GROUP_ID} ${USERNAME} && \
    adduser --system --uid ${USER_ID} --ingroup ${USERNAME} ${USERNAME}

# Change ownership of app directory
RUN chown -R ${USERNAME}:${USERNAME} /app

# Make entrypoint script executable
RUN chmod +x /app/bin/docker-entrypoint.sh

USER ${USERNAME}

EXPOSE ${APP_PORT:-3000}

ENV NODE_ENV=development
ENV HOSTNAME="0.0.0.0"

# Start in development mode with hot reloading
CMD ["sh", "-c", "pnpm run dev --host 0.0.0.0 --port ${PORT:-3000}"]